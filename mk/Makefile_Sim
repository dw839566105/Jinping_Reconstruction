evtmax:=5000
energy:=2
Radius:=0.65

duplicate:=$(shell seq -w 1 30) # ball data
scan:=$(shell seq -$(Radius) 0.01 $(Radius)) # point data
compact:=$(shell seq 0.01 0.01 0.55) $(shell seq 0.55 0.002 0.644) # calib data
valid:=$(shell seq 48 50) # validate

path:=/mnt/stage/douwei/JP_1t_paper
geo:=DetectorStructure/1t

.PHONY: all
all: ball point shell

ball: $(duplicate:%=$(path)/concat/ball/$(energy)/%.h5)
point: $(scan:%=$(path)/concat/point/x/$(energy)/%.h5) $(scan:%=$(path)/concat/point/y/$(energy)/%.h5) $(scan:%=$(path)/concat/point/z/$(energy)/%.h5)
shell: $(compact:%=$(path)/concat/shell/$(energy)/%.h5)
track: $(path)/track/shell/$(energy)/0.26.h5 $(path)/track/shell/$(energy)/0.62.h5 $(path)/track/point/z/$(energy)/0.62.h5
validate: $(valid:%=$(path)/concat/ball/$(energy)/%.h5) 

$(path)/mac/ball/$(energy)/%.mac: macro/example_ball.mac
	mkdir -p $(dir $@)
	sed -e 's/@seed/$*/; s/@particle/e-/; s/@evtmax/$(evtmax)/; s/@energy/$(energy)/; s/@Radius/$(Radius)/' $^ > $@

$(path)/mac/shell/$(energy)/%.mac: macro/example_shell.mac
	mkdir -p $(dir $@)
	sed -e 's/@seed/$*/; s/@particle/e-/; s/@evtmax/$(evtmax)/; s/@energy/$(energy)/; s/@inner/$*/; s/@outer/$*/' $^ > $@

$(path)/mac/point/x/$(energy)/%.mac: macro/example_point.mac
	mkdir -p $(dir $@)
	sed -e 's/@seed/$*/; s/@particle/e-/; s/@evtmax/$(evtmax)/; s/@energy/$(energy)/; s/@x @y @z/$* 0 0/;' $^ > $@

$(path)/mac/point/y/$(energy)/%.mac: macro/example_point.mac
	mkdir -p $(dir $@)
	sed -e 's/@seed/$*/; s/@particle/e-/; s/@evtmax/$(evtmax)/; s/@energy/$(energy)/; s/@x @y @z/0 $* 0/;' $^ > $@

$(path)/mac/point/z/$(energy)/%.mac: macro/example_point.mac
	mkdir -p $(dir $@)
	sed -e 's/@seed/$*/; s/@particle/e-/; s/@evtmax/$(evtmax)/; s/@energy/$(energy)/; s/@x @y @z/0 0 $*/;' $^ > $@

#############################################################
############### Generate h5 files in sim ####################
#############################################################

$(path)/root/%.root: $(path)/mac/%.mac
	mkdir -p $(dir $@)
	JPSim -n OFF -e ON -g $(geo) -m $^ -dn 0 -gpsFixTime ON -o $@ > $@.log 2>&1

$(path)/track/%.root: $(path)/mac/%.mac
	mkdir -p $(dir $@)
	JPSim -n OFF -e ON -g $(geo) -m $^ -dn 0 -gpsFixTime ON -t ON -o $@ > $@.log 2>&1

$(path)/track/%.h5: $(path)/track/%.root
	mkdir -p $(dir $@)
	/usr/bin/ConvertSimData $^ $@ > $@.log 2>&1

$(path)/h5/%.h5: $(path)/root/%.root
	mkdir -p $(dir $@)
	/usr/bin/ConvertSimData $^ $@ > $@.log 2>&1

$(path)/concat/%.h5: $(path)/h5/%.h5
	mkdir -p $(dir $@)
	python3 concat.py $^ -o $@ --pmt PMT.txt > $@.log

.DELETE_ON_ERROR:
.SECONDARY:
